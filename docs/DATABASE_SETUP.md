# Database Setup Guide

This document explains how database migrations and seeding work in production.

## Overview

The LocalSnow app uses **Drizzle ORM** for database management with a production-ready migration system that:

- ✅ Runs migrations automatically during deployment
- ✅ Tracks applied migrations (no duplicate runs)
- ✅ Works in production without dev dependencies
- ✅ Supports idempotent seeding
- ✅ Uses raw SQL for migrations (no drizzle-kit needed at runtime)

## Architecture

```
┌─────────────────────┐
│   Development       │
│                     │
│  drizzle-kit        │──► Generates SQL migrations
│  (dev dependency)   │    in drizzle/migrations/
└─────────────────────┘

┌─────────────────────┐
│   Production        │
│                     │
│  migrate.js         │──► Runs SQL migrations
│  (runtime script)   │    from drizzle/migrations/
│                     │
│  seed-production.js │──► Seeds reference data
│  (optional)         │    (countries, resorts, etc.)
└─────────────────────┘
```

## Files

### Migration Scripts

- **`scripts/migrate.js`** - Runs all SQL migrations from `drizzle/migrations/`
  - Tracks applied migrations in `__drizzle_migrations` table
  - Runs migrations in order (0000, 0001, 0002, ...)
  - Skips already-applied migrations
  - Uses transactions for safety

- **`scripts/seed-production.js`** - Seeds reference data
  - Countries, regions, resorts, sports
  - Idempotent (safe to run multiple times)
  - Only inserts missing data

- **`scripts/db-init.sh`** - Combined script
  - Runs migrations and optionally seeds
  - Helper wrapper around the JS scripts

- **`scripts/deploy-production.sh`** - Full deployment script
  - Builds Docker image
  - Runs migrations on VPS
  - Optionally runs seeds
  - Deploys/updates service

### Migration Files

- **`drizzle/migrations/*.sql`** - Auto-generated by drizzle-kit
  - Generated in development with `pnpm db:generate`
  - Committed to git
  - Copied to production Docker image
  - Run by `migrate.js`

## Usage

### Development

```bash
# 1. Make schema changes in src/lib/server/db/schema.ts

# 2. Generate migration
pnpm drizzle-kit generate

# 3. Apply migration locally
pnpm db:push
# OR
pnpm db:migrate

# 4. Seed data locally (optional)
pnpm seed:all
```

### Production - Initial Setup

```bash
# Option 1: Automated (recommended)
./scripts/deploy-production.sh --seed

# Option 2: Manual steps
# 2a. Build and push image
docker buildx build --platform linux/amd64 \
  -t ghcr.io/dvemolina/localsnow/localsnow:latest --push .

# 2b. Run migrations on VPS
ssh dvemolina@vmi2543894
docker run --rm \
  --network localsnow_localsnow_network \
  --secret source=localsnow_database_url,target=/run/secrets/localsnow_database_url \
  -e DATABASE_URL_FILE=/run/secrets/localsnow_database_url \
  ghcr.io/dvemolina/localsnow/localsnow:latest \
  node scripts/migrate.js

# 2c. Run seeds
docker run --rm \
  --network localsnow_localsnow_network \
  --secret source=localsnow_database_url,target=/run/secrets/localsnow_database_url \
  -e DATABASE_URL_FILE=/run/secrets/localsnow_database_url \
  ghcr.io/dvemolina/localsnow/localsnow:latest \
  node scripts/seed-production.js

# 2d. Deploy service
docker stack deploy -c docker-compose.production.yml localsnow
```

### Production - Regular Updates

```bash
# Full deployment (runs migrations automatically)
./scripts/deploy-production.sh

# Build and migrations only (don't deploy yet)
./scripts/deploy-production.sh --skip-deploy

# Run migrations only (no build/deploy)
./scripts/deploy-production.sh --migrations-only
```

## When to Run Migrations vs Seeds

### Migrations
**Run on EVERY deployment** (automated in deploy script)
- Always safe to run (idempotent)
- Applies new schema changes
- Required before app starts

### Seeds
**Run ONCE during initial setup, or when adding new reference data**
- Not needed on every deployment
- Only adds missing data (idempotent)
- Use `--seed` flag when needed

## Troubleshooting

### "relation does not exist" error

**Problem:** App is trying to query tables that don't exist

**Solution:**
```bash
# Run migrations
./scripts/deploy-production.sh --migrations-only
```

### "drizzle-kit: not found" in production

**Problem:** Trying to use drizzle-kit in production container

**Solution:** Use the provided scripts instead:
```bash
# ❌ Don't do this in production
pnpm db:migrate

# ✅ Do this instead
node scripts/migrate.js
```

### Migrations not applying

**Check migration tracking:**
```bash
# Connect to database
docker exec -it $(docker ps -q -f name=localsnow_postgres) psql -U [user] -d [dbname]

# Check applied migrations
SELECT * FROM __drizzle_migrations ORDER BY created_at;

# Check if table exists
\dt
```

### Need to revert a migration

**Rollback approach:**
1. Create a new "down" migration that undoes changes
2. Or manually fix in database and update migration tracking
3. Never delete migration files (breaks tracking)

## Best Practices

1. **Always test migrations locally first**
   ```bash
   pnpm db:migrate  # Test locally
   ```

2. **Commit migration files to git**
   - Migrations are part of your code
   - Keep them in version control

3. **Run migrations before deploying app**
   - Use `deploy-production.sh` which does this automatically
   - Or run migrations manually first

4. **Seeds are optional in production**
   - Only needed once during initial setup
   - Or when adding new reference data (new countries, resorts, etc.)

5. **Monitor migration logs**
   ```bash
   ssh dvemolina@vmi2543894 'docker service logs localsnow_app --tail 50'
   ```

6. **Backup before major migrations**
   ```bash
   # Backup production database
   ssh dvemolina@vmi2543894
   docker exec $(docker ps -q -f name=localsnow_postgres) \
     pg_dump -U [user] [dbname] > backup_$(date +%Y%m%d).sql
   ```

## FAQ

**Q: Do I need to rebuild the Docker image when I add a new migration?**
A: Yes! Migrations are part of the image and need to be included.

**Q: What if a migration fails halfway through?**
A: Migrations use transactions. If one fails, it rolls back completely. Fix the issue and try again.

**Q: Can I run seeds multiple times?**
A: Yes! Seeds are idempotent - they only insert data that doesn't exist.

**Q: How do I add a new migration?**
A:
1. Change schema in `src/lib/server/db/schema.ts`
2. Run `pnpm drizzle-kit generate`
3. Test locally with `pnpm db:migrate`
4. Commit the new migration file
5. Deploy with `./scripts/deploy-production.sh`

**Q: Where are database credentials stored?**
A: In Docker secrets. See `.env.production.secrets` template and `scripts/deploy-secrets.sh`.
