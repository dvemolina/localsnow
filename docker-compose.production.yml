version: '3.8'

# =============================================================================
# LocalSnow Production Deployment - Docker Swarm
# =============================================================================
# This docker-compose file is optimized for production deployment with:
# - Integration with existing Traefik reverse proxy
# - PostgreSQL database with health checks
# - Secure environment variable management
# - Automatic SSL via Traefik
# - Rolling updates with zero downtime
# - Health checks and auto-recovery
# =============================================================================

networks:
  # Internal network for app <-> database communication
  localsnow_network:
    driver: overlay
    attachable: true

  # Connect to EXISTING Traefik network (must already exist on VPS)
  traefik_network:
    external: true
    name: proxy

volumes:
  # Persistent storage for PostgreSQL data
  postgres_data:
    driver: local

# =============================================================================
# DOCKER SECRETS DEFINITION
# All secrets are created via scripts/deploy-secrets.sh
# Using localsnow_ prefix to avoid conflicts with other apps
# =============================================================================
secrets:
  localsnow_postgres_password:
    external: true
  localsnow_postgres_user:
    external: true
  localsnow_postgres_db:
    external: true
  localsnow_database_url:
    external: true
  localsnow_stripe_secret_key:
    external: true
  localsnow_stripe_webhook_secret:
    external: true
  localsnow_google_client_id:
    external: true
  localsnow_google_client_secret:
    external: true
  localsnow_r2_account_id:
    external: true
  localsnow_r2_access_key_id:
    external: true
  localsnow_r2_secret_access_key:
    external: true
  localsnow_r2_bucket_name:
    external: true
  localsnow_r2_public_url:
    external: true
  localsnow_cron_secret:
    external: true
  localsnow_calendar_token_encryption_key:
    external: true
  localsnow_email_header_secret:
    external: true

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    networks:
      - localsnow_network
    volumes:
      - postgres_data:/var/lib/postgresql/data
    secrets:
      - localsnow_postgres_db
      - localsnow_postgres_user
      - localsnow_postgres_password
    environment:
      # PostgreSQL reads these _FILE variants natively
      POSTGRES_DB_FILE: /run/secrets/localsnow_postgres_db
      POSTGRES_USER_FILE: /run/secrets/localsnow_postgres_user
      POSTGRES_PASSWORD_FILE: /run/secrets/localsnow_postgres_password
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$(cat /run/secrets/localsnow_postgres_user) -d $$(cat /run/secrets/localsnow_postgres_db)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ===========================================================================
  # LocalSnow Application
  # ===========================================================================
  app:
    image: ghcr.io/dvemolina/localsnow/localsnow:${IMAGE_TAG:-latest}
    networks:
      - localsnow_network
      - traefik_network
    secrets:
      - localsnow_database_url
      - localsnow_stripe_secret_key
      - localsnow_stripe_webhook_secret
      - localsnow_google_client_id
      - localsnow_google_client_secret
      - localsnow_r2_account_id
      - localsnow_r2_access_key_id
      - localsnow_r2_secret_access_key
      - localsnow_r2_bucket_name
      - localsnow_r2_public_url
      - localsnow_cron_secret
      - localsnow_calendar_token_encryption_key
      - localsnow_email_header_secret
    environment:
      # Non-secret configuration
      SEED_DATA: true
      NODE_ENV: production
      PROJECT_URL: https://localsnow.org
      ORIGIN: https://localsnow.org
      PROTOCOL_HEADER: x-forwarded-proto
      HOST_HEADER: x-forwarded-host

      # Point to Docker secret files
      # Our config.ts reads these _FILE env vars and loads the secret files
      DATABASE_URL_FILE: /run/secrets/localsnow_database_url
      STRIPE_SECRET_KEY_FILE: /run/secrets/localsnow_stripe_secret_key
      STRIPE_WEBHOOK_SECRET_FILE: /run/secrets/localsnow_stripe_webhook_secret
      GOOGLE_CLIENT_ID_FILE: /run/secrets/localsnow_google_client_id
      GOOGLE_CLIENT_SECRET_FILE: /run/secrets/localsnow_google_client_secret
      R2_ACCOUNT_ID_FILE: /run/secrets/localsnow_r2_account_id
      R2_ACCESS_KEY_ID_FILE: /run/secrets/localsnow_r2_access_key_id
      R2_SECRET_ACCESS_KEY_FILE: /run/secrets/localsnow_r2_secret_access_key
      R2_BUCKET_NAME_FILE: /run/secrets/localsnow_r2_bucket_name
      R2_PUBLIC_URL_FILE: /run/secrets/localsnow_r2_public_url
      CRON_SECRET_FILE: /run/secrets/localsnow_cron_secret
      CALENDAR_TOKEN_ENCRYPTION_KEY_FILE: /run/secrets/localsnow_calendar_token_encryption_key
      EMAIL_HEADER_SECRET_FILE: /run/secrets/localsnow_email_header_secret

    deploy:
      # Run 2 replicas for high availability
      replicas: 2

      # Rolling update configuration (zero downtime)
      update_config:
        parallelism: 1          # Update one container at a time
        delay: 10s              # Wait 10s between updates
        failure_action: rollback # Auto rollback on failure
        order: start-first      # Start new container before stopping old one

      # Rollback configuration
      rollback_config:
        parallelism: 1
        delay: 5s

      # Restart policy
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

      # Resource limits
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

      # Traefik labels for routing and SSL
      labels:
        # Enable Traefik
        - "traefik.enable=true"

        # HTTP Router - Match domain
        - "traefik.http.routers.localsnow.rule=Host(`localsnow.org`) || Host(`www.localsnow.org`)"
        - "traefik.http.routers.localsnow.entrypoints=websecure"
        - "traefik.http.routers.localsnow.tls=true"
        - "traefik.http.routers.localsnow.tls.certresolver=cloudflare"

        # Load Balancer - Target application port
        - "traefik.http.services.localsnow.loadbalancer.server.port=3000"

        # Health check for load balancer
        - "traefik.http.services.localsnow.loadbalancer.healthcheck.path=/api/health"
        - "traefik.http.services.localsnow.loadbalancer.healthcheck.interval=30s"

        # Security Headers Middleware
        - "traefik.http.middlewares.localsnow-security.headers.sslredirect=true"
        - "traefik.http.middlewares.localsnow-security.headers.stsSeconds=31536000"
        - "traefik.http.middlewares.localsnow-security.headers.stsIncludeSubdomains=true"
        - "traefik.http.middlewares.localsnow-security.headers.stsPreload=true"
        - "traefik.http.middlewares.localsnow-security.headers.frameDeny=true"
        - "traefik.http.middlewares.localsnow-security.headers.contentTypeNosniff=true"
        - "traefik.http.middlewares.localsnow-security.headers.browserXssFilter=true"
        - "traefik.http.middlewares.localsnow-security.headers.referrerPolicy=strict-origin-when-cross-origin"

        # Content Security Policy (CSP)
        - "traefik.http.middlewares.localsnow-security.headers.contentSecurityPolicy=default-src 'self'; script-src 'self' 'unsafe-inline' https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.stripe.com; frame-src https://js.stripe.com;"

        # WWW Redirect Middleware (redirect www to non-www)
        - "traefik.http.middlewares.localsnow-www-redirect.redirectregex.regex=^https://www\\.localsnow\\.org/(.*)"
        - "traefik.http.middlewares.localsnow-www-redirect.redirectregex.replacement=https://localsnow.org/$${1}"
        - "traefik.http.middlewares.localsnow-www-redirect.redirectregex.permanent=true"

        # Apply all middlewares to router
        - "traefik.http.routers.localsnow.middlewares=localsnow-www-redirect,localsnow-security"

        # Docker Swarm specific - use overlay network
        - "traefik.docker.network=proxy"

    # Health check for the application
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {let body='';r.on('data', (d) => body+=d);r.on('end', () => {const ok=r.statusCode===200;process.exit(ok?0:1);});}).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Wait for postgres to be healthy before starting
    depends_on:
      - postgres
